sequenceDiagram
    autonumber
    actor U as User
    participant UI as UI
    participant R as Reducer (comments)
    participant L as Listener (comments)
    participant O as Outbox (slice)
    participant G as Gateway (API)
    participant S as Snapshot Store

    U->>UI: Delete comment(serverId)
    UI->>R: dispatch commentDeleteOptimisticApplied(serverId)
    R-->>UI: state: soft-hide (deleted.pending=true) ou remove local
    UI->>O: dispatch commentDeleteEnqueued(cmd: Delete(serverId))
    O->>O: squash par serverId (supprime Edit en attente)
    UI->>L: (écoute) commentDeleteEnqueued

    rect rgb(245,245,245)
        L->>G: delete(serverId)
        alt Happy path
            G-->>L: 204 No Content
            L->>O: dequeue(cmd)
            L->>R: commentDeleteSucceeded(serverId) (confirm remove or deleted=true)
        else Tricky (retryable)
            G-->>L: error (network/5xx)
            L->>O: attempts+=1, lastError=...
        else Tricky (non-retryable)
            G-->>L: error (4xx)
            L->>O: dequeue(cmd)
            L->>S: read(commandId) (full comment snapshot)
            L->>R: commentDeleteFailed(serverId, err) + restore from snapshot
        end
    end

    UI->>S: save(commandId → full comment)
